{% extends 'base.html' %}
{% load mathfilters %}

{% block title %}{{ post.title }} - وبلاگ شخصی{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Content -->
    <div class="col-lg-8">
        <article class="card">
            {% if post.featured_image %}
            <img src="{{ post.featured_image.url }}" class="card-img-top" alt="{{ post.title }}"
                style="height: 400px; object-fit: cover;">
            {% endif %}

            <div class="card-body p-4">
                <h1 class="card-title mb-3" style="color: var(--text-primary);">{{ post.title }}</h1>

                <div class="post-meta mb-4 p-3 rounded" style="background: var(--bg-tertiary);">
                    <div class="row align-items-center">
                        <div class="col-md-8">
                            <div class="d-flex flex-wrap align-items-center gap-3">
                                <span style="color: var(--text-secondary);">
                                    <i class="fas fa-user me-1" style="color: var(--accent-primary);"></i>
                                    {{ post.author.get_full_name|default:post.author.username }}
                                </span>

                                <span style="color: var(--text-secondary);">
                                    <i class="fas fa-calendar me-1" style="color: var(--accent-success);"></i>
                                    {{ post.published_at|date:"j F Y - H:i" }}
                                </span>

                                <span style="color: var(--text-secondary);">
                                    <i class="fas fa-folder me-1" style="color: var(--accent-warning);"></i>
                                    <a href="{{ post.category.get_absolute_url }}"
                                        style="color: var(--accent-primary); text-decoration: none;">
                                        {{ post.category.name }}
                                    </a>
                                </span>

                                <span style="color: var(--text-secondary);">
                                    <i class="fas fa-eye me-1" style="color: var(--text-muted);"></i>
                                    {{ post.views }} بازدید
                                </span>
                            </div>
                        </div>
                        <div class="col-md-4 text-end">
                            <button class="btn btn-outline-primary btn-sm" onclick="sharePost()" title="اشتراک‌گذاری">
                                <i class="fas fa-share-alt me-1"></i>اشتراک
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Tags -->
                {% if post.tags.all %}
                <div class="mb-4">
                    <h6 style="color: var(--text-primary); margin-bottom: 0.5rem;">
                        <i class="fas fa-tags me-1" style="color: var(--accent-primary);"></i>برچسب‌ها:
                    </h6>
                    {% for tag in post.tags.all %}
                    <a href="{% url 'blog:tag_posts' tag.slug %}" class="tag">#{{ tag.name }}</a>
                    {% endfor %}
                </div>
                {% endif %}

                <!-- Post Content with Dark Theme Support -->
                <div class="post-content">
                    {{ post.content|safe }}
                </div>

                <!-- Reading Time & Social Share -->
                <div class="mt-4 pt-3" style="border-top: 1px solid var(--border-primary);">
                    <div class="row align-items-center">
                        <div class="col-md-6">
                            <small style="color: var(--text-muted);">
                                <i class="fas fa-clock me-1"></i>
                                زمان مطالعه: تقریباً {{ post.content|wordcount|add:50|div:200|floatformat:0 }} دقیقه
                            </small>
                        </div>
                        <div class="col-md-6 text-end">
                            <div class="social-share">
                                <span style="color: var(--text-muted); font-size: 0.9rem;">اشتراک‌گذاری:</span>
                                <a href="#" class="btn btn-outline-primary btn-sm ms-1" onclick="shareOnTwitter()"
                                    title="توییتر">
                                    <i class="fab fa-twitter"></i>
                                </a>
                                <a href="#" class="btn btn-outline-primary btn-sm ms-1" onclick="shareOnLinkedIn()"
                                    title="لینکدین">
                                    <i class="fab fa-linkedin"></i>
                                </a>
                                <a href="#" class="btn btn-outline-primary btn-sm ms-1" onclick="copyLink()"
                                    title="کپی لینک">
                                    <i class="fas fa-link"></i>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </article>

        <!-- Related Posts -->
        {% if related_posts %}
        <div class="mt-4">
            <h3 style="color: var(--text-primary); margin-bottom: 1.5rem;">
                <i class="fas fa-newspaper me-2" style="color: var(--accent-primary);"></i>
                پست‌های مرتبط
            </h3>
            <div class="row">
                {% for related_post in related_posts %}
                <div class="col-md-4 mb-3">
                    <div class="card h-100">
                        {% if related_post.featured_image %}
                        <img src="{{ related_post.featured_image.url }}" class="card-img-top"
                            alt="{{ related_post.title }}" style="height: 150px; object-fit: cover;">
                        {% else %}
                        <div class="card-img-top d-flex align-items-center justify-content-center"
                            style="height: 150px; background: var(--bg-tertiary);">
                            <i class="fas fa-image fa-2x" style="color: var(--text-muted);"></i>
                        </div>
                        {% endif %}
                        <div class="card-body p-3">
                            <h6 class="card-title mb-2">
                                <a href="{{ related_post.get_absolute_url }}"
                                    style="color: var(--text-primary); text-decoration: none;">
                                    {{ related_post.title|truncatewords:8 }}
                                </a>
                            </h6>
                            <small style="color: var(--text-muted);">
                                <i class="fas fa-calendar me-1"></i>{{ related_post.published_at|date:"j M Y" }}
                                <i class="fas fa-eye me-1 ms-2"></i>{{ related_post.views }}
                            </small>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Comments Section -->
        <div class="comment-section">
            <h3 style="color: var(--text-primary);">
                <i class="fas fa-comments me-2" style="color: var(--accent-primary);"></i>
                نظرات ({{ comments.count }})
            </h3>

            <!-- Comment Form -->
            <div class="comment-form">
                <h4 style="color: var(--text-primary); margin-bottom: 1rem;">
                    <i class="fas fa-pen me-2" style="color: var(--accent-primary);"></i>
                    نظر خود را بنویسید
                </h4>
                <form method="post" id="comment-form">
                    {% csrf_token %}
                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="{{ comment_form.name.id_for_label }}" class="form-label">
                                <i class="fas fa-user me-1"></i>{{ comment_form.name.label }}
                            </label>
                            {{ comment_form.name }}
                        </div>
                        <div class="col-md-6 mb-3">
                            <label for="{{ comment_form.email.id_for_label }}" class="form-label">
                                <i class="fas fa-envelope me-1"></i>{{ comment_form.email.label }}
                            </label>
                            {{ comment_form.email }}
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="{{ comment_form.content.id_for_label }}" class="form-label">
                            <i class="fas fa-comment me-1"></i>{{ comment_form.content.label }}
                        </label>
                        {{ comment_form.content }}
                        <small style="color: var(--text-muted);">حداقل ۱۰ کاراکتر وارد کنید</small>
                    </div>

                    <!-- Privacy Notice -->
                    <div class="mb-3 p-3 rounded"
                        style="background: var(--bg-secondary); border: 1px solid var(--border-primary);">
                        <small style="color: var(--text-muted);">
                            <i class="fas fa-info-circle me-1" style="color: var(--accent-primary);"></i>
                            نظر شما پس از تایید مدیر نمایش داده خواهد شد. لطفاً از زبان محترمانه استفاده کنید.
                        </small>
                    </div>

                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-paper-plane me-2"></i>
                        ارسال نظر
                    </button>
                </form>
            </div>

            <!-- Comments List -->
            <div class="comments-list mt-4">
                {% for comment in comments %}
                <div class="comment">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <div class="d-flex align-items-center">
                            <div class="comment-avatar me-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 45px; height: 45px; background: var(--accent-primary); color: white; font-weight: 600;">
                                    {{ comment.name|first|upper }}
                                </div>
                            </div>
                            <div>
                                <h6 class="mb-1">{{ comment.name }}</h6>
                                <small style="color: var(--text-muted);">
                                    <i class="fas fa-clock me-1"></i>{{ comment.created_at|date:"j F Y - H:i" }}
                                </small>
                            </div>
                        </div>
                        <div>
                            <button class="btn btn-outline-primary btn-sm" onclick="replyToComment('{{ comment.id }}')"
                                title="پاسخ">
                                <i class="fas fa-reply me-1"></i>پاسخ
                            </button>
                        </div>
                    </div>
                    <div class="comment-content">
                        <p style="color: var(--text-secondary) !important;">{{ comment.content|linebreaks }}</p>
                    </div>

                    <!-- Replies -->
                    {% for reply in comment.replies.all %}
                    {% if reply.is_approved %}
                    <div class="comment-reply">
                        <div class="d-flex align-items-start">
                            <div class="comment-avatar me-3">
                                <div class="rounded-circle d-flex align-items-center justify-content-center"
                                    style="width: 35px; height: 35px; background: var(--accent-success); color: white; font-weight: 600; font-size: 0.8rem;">
                                    {{ reply.name|first|upper }}
                                </div>
                            </div>
                            <div class="flex-grow-1">
                                <div class="d-flex justify-content-between align-items-center mb-1">
                                    <h6 class="mb-0" style="font-size: 0.9rem;">{{ reply.name }}</h6>
                                    <small style="color: var(--text-muted);">
                                        <i class="fas fa-clock me-1"></i>{{ reply.created_at|date:"j M Y - H:i" }}
                                    </small>
                                </div>
                                <p class="mb-0" style="color: var(--text-secondary) !important; font-size: 0.9rem;">
                                    {{ reply.content|linebreaks }}
                                </p>
                            </div>
                        </div>
                    </div>
                    {% endif %}
                    {% endfor %}
                </div>
                {% empty %}
                <div class="text-center py-5">
                    <i class="fas fa-comments fa-3x mb-3" style="color: var(--text-muted);"></i>
                    <h5 style="color: var(--text-secondary);">هنوز نظری ثبت نشده است</h5>
                    <p style="color: var(--text-muted);">اولین نفری باشید که نظر می‌دهد!</p>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Sidebar -->
    <div class="col-lg-4">
        <div class="sidebar">
            <h4>
                <i class="fas fa-list me-2" style="color: var(--accent-primary);"></i>
                فهرست مطالب
            </h4>
            <div id="table-of-contents">
                <!-- JavaScript will populate this -->
            </div>
        </div>

        <div class="sidebar">
            <h4>
                <i class="fas fa-folder me-2" style="color: var(--accent-warning);"></i>
                دسته‌بندی‌ها
            </h4>
            <ul class="list-unstyled">
                <li class="mb-2">
                    <a href="{% url 'blog:post_list' %}" style="color: var(--text-secondary); text-decoration: none;">
                        <i class="fas fa-newspaper me-2"></i>همه پست‌ها
                    </a>
                </li>
                <li class="mb-2">
                    <a href="{{ post.category.get_absolute_url }}"
                        style="color: var(--accent-primary); text-decoration: none;">
                        <i class="fas fa-folder-open me-2"></i>{{ post.category.name }}
                    </a>
                </li>
            </ul>
        </div>

        <div class="sidebar">
            <h4>
                <i class="fas fa-tags me-2" style="color: var(--accent-success);"></i>
                برچسب‌های این پست
            </h4>
            <div class="tag-cloud">
                {% for tag in post.tags.all %}
                <a href="{% url 'blog:tag_posts' tag.slug %}" class="tag">#{{ tag.name }}</a>
                {% endfor %}
            </div>
        </div>

        <!-- Author Info Widget -->
        <div class="sidebar">
            <h4>
                <i class="fas fa-user-edit me-2" style="color: var(--accent-primary);"></i>
                درباره نویسنده
            </h4>
            <div class="text-center mb-3">
                <div class="rounded-circle d-inline-flex align-items-center justify-content-center mb-2"
                    style="width: 80px; height: 80px; background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary)); color: white; font-size: 2rem; font-weight: 600;">
                    {{ post.author.first_name|first|default:post.author.username|first|upper }}
                </div>
                <h6 style="color: var(--text-primary);">{{ post.author.get_full_name|default:post.author.username }}
                </h6>
            </div>
            <p style="color: var(--text-secondary); font-size: 0.9rem; text-align: center;">
                نویسنده و توسعه‌دهنده وب با علاقه به تکنولوژی‌های جدید
            </p>
            <div class="text-center">
                <a href="{% url 'blog:about' %}" class="btn btn-outline-primary btn-sm">
                    <i class="fas fa-user me-1"></i>
                    مشاهده پروفایل
                </a>
            </div>
        </div>

        <!-- Popular Posts Widget -->
        <div class="sidebar">
            <h4>
                <i class="fas fa-fire me-2" style="color: var(--accent-warning);"></i>
                پست‌های محبوب
            </h4>
            {% for popular_post in related_posts %}
            <div class="d-flex mb-3 p-2 rounded" style="background-color: var(--bg-tertiary);">
                {% if popular_post.featured_image %}
                <img src="{{ popular_post.featured_image.url }}" alt="{{ popular_post.title }}" class="me-3 rounded"
                    style="width: 60px; height: 60px; object-fit: cover;">
                {% else %}
                <div class="me-3 rounded d-flex align-items-center justify-content-center"
                    style="width: 60px; height: 60px; background: var(--bg-secondary);">
                    <i class="fas fa-image" style="color: var(--text-muted);"></i>
                </div>
                {% endif %}
                <div class="flex-grow-1">
                    <h6 class="mb-1" style="font-size: 0.85rem;">
                        <a href="{{ popular_post.get_absolute_url }}"
                            style="color: var(--text-primary); text-decoration: none;">
                            {{ popular_post.title|truncatewords:5 }}
                        </a>
                    </h6>
                    <small style="color: var(--text-muted);">
                        <i class="fas fa-eye me-1"></i>{{ popular_post.views }} بازدید
                    </small>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</div>

<!-- Share Modal -->
<div class="modal fade" id="shareModal" tabindex="-1" aria-labelledby="shareModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background: var(--bg-card); border: 1px solid var(--border-primary);">
            <div class="modal-header" style="border-bottom: 1px solid var(--border-primary);">
                <h5 class="modal-title" id="shareModalLabel" style="color: var(--text-primary);">
                    <i class="fas fa-share-alt me-2" style="color: var(--accent-primary);"></i>
                    اشتراک‌گذاری پست
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="بستن"
                    style="filter: invert(1);"></button>
            </div>
            <div class="modal-body">
                <div class="row text-center">
                    <div class="col-4 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="shareOnTwitter()">
                            <i class="fab fa-twitter fa-2x mb-2 d-block"></i>
                            <small>توییتر</small>
                        </button>
                    </div>
                    <div class="col-4 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="shareOnLinkedIn()">
                            <i class="fab fa-linkedin fa-2x mb-2 d-block"></i>
                            <small>لینکدین</small>
                        </button>
                    </div>
                    <div class="col-4 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="shareOnTelegram()">
                            <i class="fab fa-telegram fa-2x mb-2 d-block"></i>
                            <small>تلگرام</small>
                        </button>
                    </div>
                    <div class="col-6 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="shareOnWhatsApp()">
                            <i class="fab fa-whatsapp fa-2x mb-2 d-block"></i>
                            <small>واتساپ</small>
                        </button>
                    </div>
                    <div class="col-6 mb-3">
                        <button class="btn btn-outline-primary w-100" onclick="copyLink()">
                            <i class="fas fa-link fa-2x mb-2 d-block"></i>
                            <small>کپی لینک</small>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Generate Table of Contents
        generateTableOfContents();

        // Comment form validation
        const commentForm = document.getElementById('comment-form');
        if (commentForm) {
            commentForm.addEventListener('submit', function (e) {
                const name = this.querySelector('input[name="name"]').value.trim();
                const email = this.querySelector('input[name="email"]').value.trim();
                const content = this.querySelector('textarea[name="content"]').value.trim();

                if (!name || !email || !content) {
                    e.preventDefault();
                    showAlert('error', 'لطفاً تمام فیلدها را پر کنید.');
                    return false;
                }

                if (content.length < 10) {
                    e.preventDefault();
                    showAlert('error', 'نظر باید حداقل ۱۰ کاراکتر باشد.');
                    return false;
                }

                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    e.preventDefault();
                    showAlert('error', 'لطفاً ایمیل معتبر وارد کنید.');
                    return false;
                }
            });
        }

        // Character counter for comment textarea
        const commentTextarea = document.querySelector('textarea[name="content"]');
        if (commentTextarea) {
            const charCounter = document.createElement('small');
            charCounter.style.color = 'var(--text-muted)';
            charCounter.style.float = 'left';
            commentTextarea.parentNode.appendChild(charCounter);

            commentTextarea.addEventListener('input', function () {
                const count = this.value.length;
                charCounter.textContent = `${count} کاراکتر`;
                charCounter.style.color = count < 10 ? 'var(--accent-danger)' : 'var(--text-muted)';
            });
        }
    });

    // Generate Table of Contents
    function generateTableOfContents() {
        const postContent = document.querySelector('.post-content');
        const tocContainer = document.getElementById('table-of-contents');

        if (!postContent || !tocContainer) return;

        const headings = postContent.querySelectorAll('h1, h2, h3, h4, h5, h6');

        if (headings.length === 0) {
            tocContainer.innerHTML = '<p style="color: var(--text-muted); font-size: 0.9rem; text-align: center;">این پست فهرست مطالب ندارد</p>';
            return;
        }

        let tocHTML = '<ul class="list-unstyled">';

        headings.forEach((heading, index) => {
            const id = `heading-${index}`;
            heading.id = id;

            const level = parseInt(heading.tagName.charAt(1));
            const indent = (level - 1) * 15;

            tocHTML += `
            <li style="margin-bottom: 0.5rem; padding-right: ${indent}px;">
                <a href="#${id}" style="color: var(--text-secondary); text-decoration: none; font-size: 0.9rem; transition: color 0.3s ease; display: block; padding: 0.25rem 0;" 
                   onmouseover="this.style.color='var(--accent-primary)'" 
                   onmouseout="this.style.color='var(--text-secondary)'">
                    <i class="fas fa-chevron-left me-2" style="font-size: 0.7rem;"></i>
                    ${heading.textContent}
                </a>
            </li>
        `;
        });

        tocHTML += '</ul>';
        tocContainer.innerHTML = tocHTML;
    }

    // Social sharing functions
    function sharePost() {
        const shareModal = new bootstrap.Modal(document.getElementById('shareModal'));
        shareModal.show();
    }

    function shareOnTwitter() {
        const url = encodeURIComponent(window.location.href);
        const text = encodeURIComponent(document.title);
        window.open(`https://twitter.com/intent/tweet?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
    }

    function shareOnLinkedIn() {
        const url = encodeURIComponent(window.location.href);
        window.open(`https://www.linkedin.com/sharing/share-offsite/?url=${url}`, '_blank', 'width=600,height=400');
    }

    function shareOnTelegram() {
        const url = encodeURIComponent(window.location.href);
        const text = encodeURIComponent(document.title);
        window.open(`https://t.me/share/url?url=${url}&text=${text}`, '_blank', 'width=600,height=400');
    }

    function shareOnWhatsApp() {
        const url = encodeURIComponent(window.location.href);
        const text = encodeURIComponent(document.title);
        window.open(`https://wa.me/?text=${text} ${url}`, '_blank', 'width=600,height=400');
    }

    function copyLink() {
        navigator.clipboard.writeText(window.location.href).then(() => {
            showAlert('success', 'لینک با موفقیت کپی شد!');
            const shareModal = bootstrap.Modal.getInstance(document.getElementById('shareModal'));
            if (shareModal) shareModal.hide();
        }).catch(() => {
            showAlert('error', 'خطا در کپی کردن لینک');
        });
    }

    function replyToComment(commentId) {
        showAlert('info', 'قابلیت پاسخ به نظرات به زودی اضافه خواهد شد.');
    }

    // Alert function
    function showAlert(type, message) {
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
        alertDiv.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 9999;
        min-width: 300px;
        border-radius: 10px;
        box-shadow: 0 4px 15px var(--shadow-medium);
    `;

        const icon = type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle';
        alertDiv.innerHTML = `
        <i class="fas fa-${icon} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert" style="filter: invert(1);"></button>
    `;

        document.body.appendChild(alertDiv);

        setTimeout(() => {
            if (alertDiv.parentNode) {
                alertDiv.style.opacity = '0';
                alertDiv.style.transform = 'translateY(-20px)';
                setTimeout(() => alertDiv.remove(), 300);
            }
        }, 5000);
    }

    // Smooth scrolling for TOC links
    document.addEventListener('click', function (e) {
        if (e.target.matches('a[href^="#heading-"]') || e.target.closest('a[href^="#heading-"]')) {
            e.preventDefault();
            const link = e.target.matches('a[href^="#heading-"]') ? e.target : e.target.closest('a[href^="#heading-"]');
            const target = document.querySelector(link.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });

                // Highlight the target heading temporarily
                target.style.background = 'var(--bg-tertiary)';
                target.style.padding = '0.5rem';
                target.style.borderRadius = '8px';
                target.style.transition = 'all 0.3s ease';

                setTimeout(() => {
                    target.style.background = 'transparent';
                    target.style.padding = '0';
                }, 2000);
            }
        }
    });

    // Reading progress indicator
    window.addEventListener('scroll', function () {
        const article = document.querySelector('article');
        if (!article) return;

        const articleTop = article.offsetTop;
        const articleHeight = article.offsetHeight;
        const windowHeight = window.innerHeight;
        const scrollTop = window.pageYOffset;

        const progress = Math.min(100, Math.max(0,
            ((scrollTop - articleTop + windowHeight / 2) / articleHeight) * 100
        ));

        // Update progress bar if exists
        let progressBar = document.getElementById('reading-progress');
        if (!progressBar) {
            progressBar = document.createElement('div');
            progressBar.id = 'reading-progress';
            progressBar.style.cssText = `
            position: fixed;
            top: 0;
            left: 0;
            width: ${progress}%;
            height: 3px;
            background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
            z-index: 9999;
            transition: width 0.1s ease;
        `;
            document.body.appendChild(progressBar);
        }

        progressBar.style.width = `${progress}%`;
    });

    // Lazy loading for images in post content
    const images = document.querySelectorAll('.post-content img');
    const imageObserver = new IntersectionObserver((entries, observer) => {
        entries.forEach(entry => {
            if (entry.isIntersecting) {
                const img = entry.target;

                // Add loading animation
                img.style.opacity = '0';
                img.style.transform = 'scale(0.8)';
                img.style.transition = 'all 0.3s ease';

                img.onload = function () {
                    this.style.opacity = '1';
                    this.style.transform = 'scale(1)';
                };

                observer.unobserve(img);
            }
        });
    }, {
        threshold: 0.1
    });

    images.forEach(img => imageObserver.observe(img));

    // Print functionality
    function printPost() {
        const printWindow = window.open('', '_blank');
        const postContent = document.querySelector('.post-content').innerHTML;
        const postTitle = document.querySelector('h1').textContent;

        printWindow.document.write(`
        <!DOCTYPE html>
        <html dir="rtl" lang="fa">
        <head>
            <meta charset="UTF-8">
            <title>${postTitle}</title>
            <style>
                body { font-family: 'Vazirmatn', Tahoma, sans-serif; line-height: 1.8; color: #333; }
                h1, h2, h3, h4, h5, h6 { color: #2c3e50; margin-top: 1.5rem; }
                img { max-width: 100%; height: auto; }
                pre { background: #f8f9fa; padding: 1rem; border-radius: 5px; }
                blockquote { border-right: 4px solid #007bff; padding: 1rem; background: #f8f9fa; }
            </style>
        </head>
        <body>
            <h1>${postTitle}</h1>
            ${postContent}
        </body>
        </html>
    `);

        printWindow.document.close();
        printWindow.print();
    }

    // Keyboard shortcuts
    document.addEventListener('keydown', function (e) {
        // Ctrl/Cmd + P for print
        if ((e.ctrlKey || e.metaKey) && e.key === 'p') {
            e.preventDefault();
            printPost();
        }

        // Ctrl/Cmd + K for share
        if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
            e.preventDefault();
            sharePost();
        }

        // ESC to close modals
        if (e.key === 'Escape') {
            const modals = document.querySelectorAll('.modal.show');
            modals.forEach(modal => {
                const modalInstance = bootstrap.Modal.getInstance(modal);
                if (modalInstance) modalInstance.hide();
            });
        }
    });

    // Add print and keyboard shortcut buttons
    document.addEventListener('DOMContentLoaded', function () {
        const socialShare = document.querySelector('.social-share');
        if (socialShare) {
            const printBtn = document.createElement('a');
            printBtn.href = '#';
            printBtn.className = 'btn btn-outline-primary btn-sm ms-1';
            printBtn.title = 'چاپ (Ctrl+P)';
            printBtn.innerHTML = '<i class="fas fa-print"></i>';
            printBtn.onclick = function (e) {
                e.preventDefault();
                printPost();
            };

            socialShare.appendChild(printBtn);
        }
    });

    // Enhanced comment validation with real-time feedback
    const commentInputs = document.querySelectorAll('#comment-form input, #comment-form textarea');
    commentInputs.forEach(input => {
        input.addEventListener('blur', function () {
            validateField(this);
        });

        input.addEventListener('input', function () {
            // Remove error styling on input
            this.classList.remove('is-invalid');
            const feedback = this.parentNode.querySelector('.invalid-feedback');
            if (feedback) feedback.remove();
        });
    });

    function validateField(field) {
        let isValid = true;
        let message = '';

        // Remove existing feedback
        field.classList.remove('is-invalid');
        const existingFeedback = field.parentNode.querySelector('.invalid-feedback');
        if (existingFeedback) existingFeedback.remove();

        // Validate based on field
        switch (field.name) {
            case 'name':
                if (field.value.trim().length < 2) {
                    isValid = false;
                    message = 'نام باید حداقل ۲ کاراکتر باشد';
                }
                break;
            case 'email':
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(field.value)) {
                    isValid = false;
                    message = 'لطفاً ایمیل معتبر وارد کنید';
                }
                break;
            case 'content':
                if (field.value.trim().length < 10) {
                    isValid = false;
                    message = 'نظر باید حداقل ۱۰ کاراکتر باشد';
                }
                break;
        }

        if (!isValid) {
            field.classList.add('is-invalid');
            const feedback = document.createElement('div');
            feedback.className = 'invalid-feedback';
            feedback.textContent = message;
            field.parentNode.appendChild(feedback);
        }

        return isValid;
    }
</script>

<style>
    /* Additional styles for enhanced functionality */
    .is-invalid {
        border-color: var(--accent-danger) !important;
        box-shadow: 0 0 0 0.2rem rgba(248, 81, 73, 0.25) !important;
    }

    .invalid-feedback {
        color: var(--accent-danger);
        font-size: 0.875rem;
        margin-top: 0.25rem;
    }

    #reading-progress {
        position: fixed;
        top: 0;
        left: 0;
        height: 3px;
        background: linear-gradient(90deg, var(--accent-primary), var(--accent-secondary));
        z-index: 9999;
        transition: width 0.1s ease;
    }

    .comment-avatar {
        transition: transform 0.3s ease;
    }

    .comment-avatar:hover {
        transform: scale(1.1);
    }

    .social-share a {
        transition: all 0.3s ease;
    }

    .social-share a:hover {
        transform: translateY(-2px);
    }

    .tag-cloud .tag {
        transition: all 0.3s ease;
        margin: 0.25rem;
    }

    .tag-cloud .tag:hover {
        transform: scale(1.05);
    }

    /* Print styles */
    @media print {

        .sidebar,
        .comment-section,
        .social-share,
        .btn,
        nav,
        footer {
            display: none !important;
        }

        .col-lg-8 {
            width: 100% !important;
        }

        .post-content {
            color: #000 !important;
        }

        .post-content * {
            color: #000 !important;
        }
    }

    /* High contrast mode */
    @media (prefers-contrast: high) {
        .post-content {
            color: #ffffff !important;
        }

        .post-content * {
            color: #ffffff !important;
        }

        .post-content a {
            color: #66b3ff !important;
        }
    }

    /* Reduced motion */
    @media (prefers-reduced-motion: reduce) {

        .comment-avatar,
        .social-share a,
        .tag {
            transition: none !important;
        }

        #reading-progress {
            transition: none !important;
        }
    }

    /* Mobile optimizations */
    @media (max-width: 768px) {
        .social-share {
            text-align: center;
            margin-top: 1rem;
        }

        .social-share span {
            display: block;
            margin-bottom: 0.5rem;
        }

        .modal-dialog {
            margin: 1rem;
        }

        .comment-reply {
            margin-right: 1rem;
            padding: 0.75rem;
        }

        .comment-avatar {
            width: 35px !important;
            height: 35px !important;
            font-size: 0.9rem !important;
        }
    }
</style>
{% endblock %}